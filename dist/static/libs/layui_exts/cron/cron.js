layui.define(["lay","element","form"],function(e){function d(e){var n=this;n.index=++t.index,n.config=c.extend({},n.config,t.config,e),t.ready(function(){n.init()})}var c=layui.$,r=layui.layer,y=layui.lay,i=layui.element,u=layui.form,p="layui-cron-static",a="layui-cron-hint",l="layui-cron-run-hint",t={v:"2.0.0",index:layui.cron?layui.cron.index+1e4:0,set:function(e){var n=this;return n.config=c.extend({},n.config,e),n},on:function(e,n){return layui.onevent.call(this,"cron",e,n)},ready:function(e){var n=layui.cache.base+"cron/cron.css?v="+t.v;return layui.link(n,e,"cron"),this}};d.prototype.config={value:null,isInitValue:!0,lang:"cn",tabs:[{key:"minutes",range:"0-59"},{key:"hours",range:"0-23"},{key:"days",range:"1-31"},{key:"months",range:"1-12"},{key:"weeks",range:"1-7"}],defaultCron:{minutes:"*",hours:"*",days:"*",months:"*",weeks:"*"},trigger:"click",btns:["run","confirm"],position:null,zIndex:null,show:!1,showBottom:!0,done:null,run:null},d.prototype.lang=function(){var e={cn:{tabs:[{title:"分"},{title:"时"},{title:"日"},{title:"月"},{title:"周",rateBegin:"第",rateMid:"周的星期",rateEnd:""}],every:"每",unspecified:"不指定",period:"周期",periodFrom:"从",rate:"按照",rateBegin:"从",rateMid:"开始，每",rateEnd:"执行一次",weekday:"工作日",weekdayPrefix:"每月",weekdaySuffix:"号最近的那个工作日",lastday:"本月最后一日",lastweek:"本月最后一个星期",custom:"指定",tools:{confirm:"确定",run:"运行"},formatError:["Cron格式不合法","<br>已为你重置"]},en:{tabs:[{title:"Minutes"},{title:"Hours"},{title:"Days"},{title:"Months"},{title:"Weeks"}],every:"Every ",unspecified:"Unspecified",period:"Period",periodFrom:"From",rate:"According to",rateBegin:"begin at",rateMid:", every",rateEnd:" execute once",weekday:"Weekday",weekdayPrefix:"Every month at ",weekdaySuffix:"号最近的那个工作日",lastday:"Last day of the month",lastweek:"本月最后一个星期",custom:"Custom",tools:{confirm:"Confirm",run:"Run"},formatError:["The cron format error","<br>It has been reset"]}};return e[this.config.lang]||e.cn},d.prototype.init=function(){var e,n=this,t=n.config,i="static"===t.position;t.elem=y(t.elem),t.eventElem=y(t.eventElem),t.elem[0]&&(n.isInput(t.elem[0])||"focus"===t.trigger&&(t.trigger="click"),t.elem.attr("lay-key")||(t.elem.attr("lay-key",n.index),t.eventElem.attr("lay-key",n.index)),n.elemID="layui-icon"+t.elem.attr("lay-key"),t.value&&t.isInitValue&&n.setValue(t.value),t.value||(t.value=t.elem[0].value||""),4<=(e=t.value.split(" ")).length?t.cron={minutes:e[0],hours:e[1],days:e[2],months:e[3],weeks:e[4]}:t.cron=y.extend({},t.defaultCron),(t.show||i)&&n.render(),i||n.events())},d.prototype.render=function(){var i,a=this,e=a.config,r=a.lang(),n="static"===e.position,t="cron-tab"+e.elem.attr("lay-key"),l=a.elem=y.elem("div",{id:a.elemID,class:["layui-cron",n?" "+p:""].join("")}),t=a.elemTab=y.elem("div",{class:"layui-tab layui-tab-card","lay-filter":t}),o=y.elem("ul",{class:"layui-tab-title"}),s=y.elem("div",{class:"layui-tab-content"}),c=a.footer=y.elem("div",{class:"layui-cron-footer"});e.zIndex&&(l.style.zIndex=e.zIndex),t.appendChild(o),t.appendChild(s),y.each(r.tabs,function(e,n){var t=y.elem("li",{class:0===e?"layui-this":"","lay-id":e});t.innerHTML=n.title,o.appendChild(t),s.appendChild(a.getTabContentChildElem(e))}),(elemMain=a.elemMain=y.elem("div",{class:"layui-cron-main"})).appendChild(t),y(c).html((t=[],i=[],y.each(e.btns,function(e,n){var t=r.tools[n]||"btn";i.push('<span lay-type="'+n+'" class="cron-btns-'+n+'">'+t+"</span>")}),t.push('<div class="cron-footer-btns">'+i.join("")+"</div>"),t.join(""))),l.appendChild(elemMain),e.showBottom&&l.appendChild(c),a.remove(d.thisElemCron),n?e.elem.append(l):(document.body.appendChild(l),a.position()),a.checkCron(),a.elemEvent(),d.thisElemCron=a.elemID,u.render()},d.prototype.getTabContentChildElem=function(i){var t,a,r,e=this.config,n=e.tabs[i],l=n.key,o=this.lang(),s=o.tabs[i],c=e.cron,e="cronForm"+l+e.elem.attr("lay-key"),d=-1!=c[l].indexOf("-")?{type:"range",start:(p=c[l].split("-"))[0],end:p[1]}:-1!=c[l].indexOf("/")?{type:"rate",begin:(p=c[l].split("/"))[0],rate:p[1]}:-1!=c[l].indexOf(",")||/^\+?[0-9][0-9]*$/.test(c[l])?{type:"custom",values:p=c[l].split(",").map(Number)}:-1!=c[l].indexOf("W")?{type:"weekday",value:c[l].replace("W","")}:2===i&&"L"===c[l]?{type:"lastday",value:"L"}:4===i&&-1!=c[l].indexOf("L")?{type:"lastweek",value:c[l].replace("L","")}:"*"===c[l]?{type:"every",value:"*"}:"?"===c[l]||void 0===c[l]||""===c[l]?{type:"unspecified",value:c[l]}:void 0,u=(()=>{var e;if(n.range)return e=n.range.split("-"),{min:parseInt(e[0]),max:parseInt(e[1])}})(),p=y.elem("div",{class:"layui-tab-item layui-form "+(0===i?"layui-show":""),"lay-filter":e}),c=(p.appendChild((c=y.elem("input",{name:l+"[type]",type:"radio",value:"every",title:o.every+s.title}),"every"===d.type&&y(c).attr("checked",!0),(e=y.elem("div",{class:"cron-row"})).appendChild(c),e)),2<=i&&p.appendChild((c=y.elem("input",{name:l+"[type]",type:"radio",value:"unspecified",title:o.unspecified}),"unspecified"===d.type&&y(c).attr("checked",!0),(e=y.elem("div",{class:"cron-row"})).appendChild(c),e)),[(c=y.elem("input",{name:l+"[type]",type:"radio",value:"range",title:o.period}),"range"===d.type&&y(c).attr("checked",!0),c),((e=y.elem("div",{class:"cron-input-mid"})).innerHTML=o.periodFrom,e),y.elem("input",{class:"cron-input",type:"number",name:"rangeStart",value:d.start||""}),((c=y.elem("div",{class:"cron-input-mid"})).innerHTML="-",c),y.elem("input",{class:"cron-input",type:"number",name:"rangeEnd",value:d.end||""}),((e=y.elem("div",{class:"cron-input-mid"})).innerHTML=s.title,e)]),m=y.elem("div",{class:"cron-row"});return y.each(c,function(e,n){m.appendChild(n)}),n.range&&((e=y.elem("div",{class:"cron-tips"})).innerHTML=["(",n.range,")"].join(""),m.appendChild(e)),p.appendChild(m),i<4&&(c=[(c=y.elem("input",{name:l+"[type]",type:"radio",value:"rate",title:o.rate}),"rate"===d.type&&y(c).attr("checked",!0),c),((e=y.elem("div",{class:"cron-input-mid"})).innerHTML=s.rateBegin||o.rateBegin,e),y.elem("input",{class:"cron-input",type:"number",name:"begin",value:d.begin||""}),((c=y.elem("div",{class:"cron-input-mid"})).innerHTML=s.rateMid||s.title+o.rateMid,c),y.elem("input",{class:"cron-input",type:"number",name:"rate",value:d.rate||""}),((e=y.elem("div",{class:"cron-input-mid"})).innerHTML=null!=s.rateEnd?s.rateEnd:s.title+o.rateEnd,null!=s.rateEnd&&""===s.rateEnd&&y(e).addClass("layui-hide"),e)],t=y.elem("div",{class:"cron-row"}),y.each(c,function(e,n){t.appendChild(n)}),n.range&&((s=y.elem("div",{class:"cron-tips"})).innerHTML=["(",u.min,"/",u.max+(i<=1?1:0),")"].join(""),t.appendChild(s)),p.appendChild(t)),2===i&&(c=[(e=y.elem("input",{name:l+"[type]",type:"radio",value:"weekday",title:o.weekday}),"weekday"===d.type&&y(e).attr("checked",!0),e),((c=y.elem("div",{class:"cron-input-mid"})).innerHTML=o.weekdayPrefix,c),y.elem("input",{class:"cron-input",type:"number",name:"weekday",value:d.value||""}),((s=y.elem("div",{class:"cron-input-mid"})).innerHTML=o.weekdaySuffix,s),((e=y.elem("div",{class:"cron-tips"})).innerHTML=["(",n.range,")"].join(""),e)],a=y.elem("div",{class:"cron-row"}),y.each(c,function(e,n){a.appendChild(n)}),p.appendChild(a),p.appendChild((s=y.elem("input",{name:l+"[type]",type:"radio",value:"lastday",title:o.lastday}),"lastday"===d.type&&y(s).attr("checked",!0),(e=y.elem("div",{class:"cron-row"})).appendChild(s),e))),4===i&&(e=[(c=y.elem("input",{name:l+"[type]",type:"radio",value:"lastweek",title:o.lastweek}),"lastweek"===d.type&&y(c).attr("checked",!0),c),y.elem("input",{class:"cron-input",type:"number",name:"lastweek",value:d.value||""}),((s=y.elem("div",{class:"cron-tips"})).innerHTML=["(",n.range,")"].join(""),s)],r=y.elem("div",{class:"cron-row"}),y.each(e,function(e,n){r.appendChild(n)}),p.appendChild(r)),i<=4&&(p.appendChild((c=y.elem("input",{name:l+"[type]",type:"radio",value:"custom",title:o.custom}),"custom"===d.type&&y(c).attr("checked",!0),(s=y.elem("div",{class:"cron-row"})).appendChild(c),s)),p.appendChild((()=>{for(var e=y.elem("div",{class:"cron-grid"}),n=u.min;n<=u.max;){var t=i<=1?y.digit(n,2):n,t=y.elem("input",{type:"checkbox",title:t,"lay-skin":"primary",name:l+"[custom]",value:n});d.values&&d.values.includes(n)&&y(t).attr("checked",!0),e.appendChild(t),n++}return e})())),p},d.prototype.isInput=function(e){return/input|textarea/.test(e.tagName.toLocaleLowerCase())},d.prototype.events=function(){function e(e,n){e.on(i.trigger,function(){n&&(t.bindElem=this),t.render()})}var t=this,i=t.config;i.elem[0]&&!i.elem[0].eventHandler&&(e(i.elem,"bind"),e(i.eventElem),y(document).on("click",function(e){e.target!==i.elem[0]&&e.target!==i.eventElem[0]&&e.target!==y(i.closeStop)[0]&&t.remove()}).on("keydown",function(e){13===e.keyCode&&y("#"+t.elemID)[0]&&t.elemID===d.thisElemDate&&(e.preventDefault(),y(t.footer).find(".cron-btns-confirm")[0].click())}),y(window).on("resize",function(){if(!t.elem||!y(".layui-cron")[0])return!1;t.position()}),i.elem[0].eventHandler=!0)},d.prototype.elemEvent=function(){var n=this,t="cron-tab"+n.config.elem.attr("lay-key");y(n.elem).on("click",function(e){y.stope(e)}),y(n.elemTab).find("li").on("click",function(){var e=y(this).attr("lay-id");void 0!==e&&i.tabChange(t,e)}),u.on("radio",function(e){var n=e.othis.parent(),t=n.parent().attr("lay-filter"),i=u.val(t),e=e.value;"range"===e&&u.val(t,{rangeStart:i.rangeStart||0,rangeEnd:i.rangeEnd||2}),"rate"===e&&u.val(t,{begin:i.begin||0,rate:i.rate||2}),"custom"===e&&(n=n.next()).find(":checkbox:checked").length<=0&&n.children(":checkbox:first").next().click(),"weekday"===e&&u.val(t,{weekday:i.weekday||1}),"lastweek"===e&&u.val(t,{lastweek:i.lastweek||1})}),y(n.footer).find("span").on("click",function(){var e=y(this).attr("lay-type");n.tool(this,e)})},d.prototype.tool=function(e,n){var t=this,i=t.config,a=(t.lang(),i.position,{run:function(){var e=t.parse(),n=r.load();c.get(i.run,{cron:e},function(e){if(r.close(n),0!==e.code)return t.hint(e.msg);t.runHint(e.data)},"json").fail(function(){r.close(n),t.hint("服务器异常！")})},confirm:function(){var e=t.parse();t.done([e]),t.setValue(e).remove()}});a[n]&&a[n]()},d.prototype.done=function(e,n){var t=this.config;return e=e||[this.parse()],"function"==typeof t[n||"done"]&&t[n||"done"].apply(t,e),this},d.prototype.parse=function(){var o=this.config,s=[];return y.each(o.tabs,function(e,n){var t,i=n.key,a="cronForm"+i+o.elem.attr("lay-key"),a=u.val(a),r=i+"[type]",l="";"every"===a[r]&&(l="*"),"range"===a[r]&&(l=a.rangeStart+"-"+a.rangeEnd),"rate"===a[r]&&(l=a.begin+"/"+a.rate),"custom"===a[r]&&(n=n.key+"[custom]",t=[],c('input[name="'+n+'"]:checked').each(function(){t.push(c(this).val())}),l=t.join(",")),"weekday"===a[r]&&(l=a.weekday+"W"),"lastday"===a[r]&&(l="L"),"lastweek"===a[r]&&(l=a.lastweek+"L"),""!==(l="unspecified"===a[r]&&4!=e?"?":l)&&(s.push(l),o.cron[i]=l)}),s.join(" ")},d.prototype.remove=function(e){var n=this,t=(n.config,y("#"+(e||n.elemID)));return t[0]&&!t.hasClass(p)&&n.checkCron(function(){t.remove()}),n},d.prototype.position=function(){var e=this.config;return y.position(this.bindElem||e.elem[0],this.elem,{position:e.position}),this},d.prototype.hint=function(e){var n=this,t=(n.config,y.elem("div",{class:a}));n.elem&&(t.innerHTML=e||"",y(n.elem).find("."+a).remove(),n.elem.appendChild(t),clearTimeout(n.hinTimer),n.hinTimer=setTimeout(function(){y(n.elem).find("."+a).remove()},3e3))},d.prototype.runHint=function(e){this.config;var t,n=y.elem("div",{class:l});this.elem&&e&&e.length&&(y(n).html((t=[],y.each(e,function(e,n){t.push('<div class="cron-run-list">'+n+"</div>")}),t.join(""))),y(this.elem).find("."+l).remove(),this.elem.appendChild(n))},d.prototype.setValue=function(e=""){var n=this.config,t=this.bindElem||n.elem[0],i=this.isInput(t)?"val":"html";return"static"!==n.position&&y(t)[i](e||""),this},d.prototype.checkCron=function(e){var n=this,t=n.config,i=(n.lang(),n.bindElem||t.elem[0]),i=n.isInput(i)?i.value:"static"===t.position?"":i.innerHTML;return"string"==typeof(i=i||t.value)&&(i=i.replace(/\s+/g,"").replace(/^\s|\s$/g,"")),"init"===e?[[][0]=0]=[i]:((i=n.parse())&&n.setValue(i),e&&e()),n},t.render=function(e){e=new d(e);return function(){var n=this,e=n.config;e.id||e.index;return{hint:function(e){n.hint.call(n,e)},config:e}}.call(e)},e("cron",t)});