layui.define(["element","util","layer"],function(e){function t(e){var t={filter:m.config.tabFilter,naletr:[{eventName:"closeThis",title:"关闭",icon:"iconfont icon-cuowuguanbiquxiao"},{eventName:"refreshThis",title:"刷新标签",icon:"iconfont icon-shuaxin"},{eventName:"toggleFullScreen",title:"全屏显示",icon:"layui-icon layui-icon-screen-full"},{eventName:"line",title:""},{eventName:"closeLeft",title:"关闭左侧标签页",icon:"iconfont icon-diyiye"},{eventName:"closeRight",title:"关闭右侧标签页",icon:"iconfont icon-zuihouye"},{eventName:"line",title:""},{eventName:"closeOther",title:"关闭其它标签页",icon:"iconfont icon-hengxiangshouqi"},{eventName:"closeAll",title:"关闭所有标签页",icon:"iconfont icon-guanbiquanbu"}]};this.config={...t,...e},this.config&&this.render(this.config)}let u=layui.element,h=layui.jquery,d=layui.layer;function f(e,t){e.scrollLeft();var i=t.offset().left-e.offset().left+e.scrollLeft(),t=t.outerWidth();e.animate({scrollLeft:i-(e.width()-t)/2},300)}t.prototype.render=function(e){e.filter?(this.filter=e.filter,this.naletr=e.naletr,document.fullscreenElement===this.fullScreenTarget?this.menuElement||(this.menuElement=h("<ul class='right-menu'></ul>").appendTo(this.fullScreenTarget)):this.menuElement||(this.menuElement=h("<ul class='right-menu'></ul>").appendTo("body")),this.renderMenuItems(),this.bindEvents(),this.fullScreenTarget=document.querySelector('[lay-filter="'+this.filter+'"]'),this.fullScreenTarget?this.fullScreenTarget.addEventListener("fullscreenchange",()=>{this.updateFullScreenMenuItem(),this.updateMenuParent()}):console.error("[ERROR] 未找到符合 'filter' 的全屏目标元素！")):console.error("[ERROR] 使用 tabRightMenu 组件需要指定 'filter' 属性！")},t.prototype.updateMenuParent=function(){document.fullscreenElement===this.fullScreenTarget?this.menuElement.appendTo(this.fullScreenTarget):this.menuElement.appendTo("body")},t.prototype.renderMenuItems=function(){this.menuElement.empty(),this.naletr.forEach(e=>{("line"===e.eventName?h("<hr>"):h("<li class='right-menu-item'  data-event='"+e.eventName+"'><i class='"+e.icon+"'></i> "+e.title+"</li>")).appendTo(this.menuElement)}),this.updateFullScreenMenuItem()},t.prototype.updateFullScreenMenuItem=function(){var e=this.menuElement.find("[data-event='toggleFullScreen']"),t=h('[lay-header-event="tabFullScreen"]');document.fullscreenElement===this.fullScreenTarget?(e.html("<i class='layui-icon layui-icon-screen-restore'></i> 退出全屏"),t.html("<em class='layui-icon layui-icon-screen-restore'></em>")):(e.html("<i class='layui-icon layui-icon-screen-full'></i> 全屏显示"),t.html("<em class='layui-icon layui-icon-screen-full'></em>"))},t.prototype.bindEvents=function(){let t=this;h("#happy-content .layui-body-tabs").on("contextmenu",".layui-tab-title > li",e=>{e.preventDefault(),t.showMenu(e,h(e.currentTarget).attr("lay-id"))}),h(document).off("click.rightMenu"),h(document).on("click.rightMenu",e=>{t.menuElement.is(e.target)||0!==t.menuElement.has(e.target).length||t.hideMenu()}),t.menuElement.off("click.rightMenuItem"),t.menuElement.on("click.rightMenuItem","li[data-event]",e=>{e.stopPropagation();e=h(e.currentTarget).attr("data-event");e&&t.handleMenuItemClick(e)})},t.prototype.showMenu=function(i,n){if(n){this.currentActiveTabID=n;n=this.menuElement;let e=h(document).width()-i.clientX<n.width()?i.clientX-n.width():i.clientX,t=h(document).height()-i.clientY<n.height()?i.clientY-n.height():i.clientY;document.fullscreenElement===this.fullScreenTarget&&(i=h(this.fullScreenTarget).offset(),e-=i.left,t-=i.top),n.css({left:e,top:t}).show()}},t.prototype.hideMenu=function(){this.menuElement.hide()},t.prototype.handleMenuItemClick=function(e){if(e){m.onTab();var t=h(".layui-tab[lay-filter='"+this.filter+"'] li");let n=!1;switch(e){case"refreshThis":h(`.layui-tab-item[lay-id="${this.currentActiveTabID}"]`).length&&h('[lay-header-event="refreshTab"]').trigger("click");break;case"closeThis":u.tabDelete(this.filter,this.currentActiveTabID);var i=t.not(`[lay-id="${this.currentActiveTabID}"]`).first();i.length&&u.tabChange(this.filter,i.attr("lay-id"));break;case"toggleFullScreen":this.toggleFullScreen();break;case"closeAll":h.each(t,(e,t)=>{t=h(t).attr("lay-id");u.tabDelete(this.filter,t)});break;case"closeOther":h.each(t,(e,t)=>{t=h(t).attr("lay-id");t!==this.currentActiveTabID&&u.tabDelete(this.filter,t)});break;case"closeLeft":h.each(t,(e,t)=>{t=h(t).attr("lay-id");t===this.currentActiveTabID?n=!0:n||u.tabDelete(this.filter,t)});break;case"closeRight":n=!1,h.each(t,(e,t)=>{let i=h(t).attr("lay-id");i===this.currentActiveTabID?n=!0:n&&setTimeout(()=>{u.tabDelete(this.filter,i)},0)})}this.hideMenu()}},t.prototype.toggleFullScreen=function(){if(this.fullScreenTarget)if(document.fullscreenElement)try{m.exitFullscreen().then(()=>{this.updateFullScreenMenuItem(),this.updateMenuParent()}).catch(e=>{d.msg("无法退出全屏模式,请手动操作")})}catch(e){d.msg("无法退出全屏模式,请手动操作")}else try{m.requestFullscreen(this.fullScreenTarget).then(()=>{this.updateFullScreenMenuItem(),this.updateMenuParent()}).catch(e=>{d.msg("无法进入全屏模式,请手动操作")})}catch(e){d.msg("无法进入全屏模式,请手动操作")}else console.error("[ERROR] 未找到符合 'filter' 的全屏目标元素！")};let m={config:{tabFilter:"layout-filter-tab",tabsContent:"#happy-content > .layui-body-tabs"},showLoadingBar:function(){h("#loading-bar").css("width","0%").show(),setTimeout(()=>{h("#loading-bar").css("width","100%")},0)},hideLoadingBar:function(){setTimeout(()=>{h("#loading-bar").css("width","0%").hide()},2e3)},getActiveTabId:function(){return h(this.config.tabsContent).find(".layui-tab-title li[lay-id].layui-this").attr("lay-id")},refreshTab:function(){var e=this.getActiveTabId();e&&u.tabChange(this.config.tabFilter,e)},addTab:function(e){var t=String(e.id),i=e.url,n=e.change??!1,a=e.allowClose??!0,e=e.title;this.tabIsExist(t)?(h(`[lay-filter="${this.config.tabFilter}"]`).find('[data-page-id="'+t+'"]').attr("data-src",i),n&&u.tabChange(this.config.tabFilter,t)):u.tabAdd(this.config.tabFilter,{id:t,title:e,url:i,change:n,allowClose:a})},updateTabData:function(e,t){var i=JSON.parse(sessionStorage.getItem("tabsList"))||[];let n=String(e);-1===i.findIndex(e=>e.id===n)&&i.push({id:n,...t}),sessionStorage.setItem("tabsList",JSON.stringify(i)),sessionStorage.setItem("tabsActiveId",n)},delTabData:function(t){var e=JSON.parse(sessionStorage.getItem("tabsList"))||[];let i=sessionStorage.getItem("tabsActiveId");var n=e.findIndex(e=>e.id===t);-1!==n?(e.splice(n,1),t===i&&(0<e.length?(i=e[0].id,u.tabChange(this.config.tabFilter,i)):i=null),sessionStorage.setItem("tabsList",JSON.stringify(e)),sessionStorage.setItem("tabsActiveId",i)):t===i&&(i=0<e.length?e[0].id:null,sessionStorage.setItem("tabsActiveId",i))},tabIsExist:function(e){let t=!1;return h(this.config.tabsContent).find(".layui-tab-title li").each(function(){if(h(this).attr("lay-id")===e)return!(t=!0)}),t},clearOtherTabsContent:function(e){h(this.config.tabsContent).find(".layui-tab-item").each(function(){h(this).attr("lay-id")!==e&&h(this).find(".happy-tab-content").empty()})},onTab:function(){let o=this;u.on("tab("+this.config.tabFilter+")",function(e){var t=h(e.elem),i=t.find(".layui-this");f(t,i);let n=e.id;var a=t.find(`.layui-tab-title li[lay-id="${n}"]`);let l=a.attr("lay-url");var r=a.attr("lay-allowclose");let s=t.find(`.layui-tab-item[lay-id="${n}"]`);var c=s.find(".happy-tab-content").attr("data-src");c&&(l=c),o.updateTabData(n,{id:n,title:a.text(),url:l,allowClose:r}),l&&(m.showLoadingBar(),h.ajax({url:l,type:"GET",dataType:"html",success:function(e){var t;e.startsWith("{")||e.startsWith("[")?((e=JSON.parse(e)).info&&d.msg(e.info),e.url&&setTimeout(function(){window.location.href=e.url},1500)):(t=s.width(),s.html(`<div class="happy-tab-content" 
                                 style="display:block; width: ${t}" 
                                 data-page-id="${n}" 
                                 data-src="${l}">
                                ${e}
                            </div>`),u.init(),setTimeout(()=>{s.find(".happy-tab-content").addClass("animated slideInFromBottom")},200),m.hideLoadingBar())},error:function(){d.msg("加载失败，请重试！"),m.hideLoadingBar()}})),m.clearOtherTabsContent(n),o.activeTabMenu(e.id),o.autoScrollToActiveTab(t,i)}),u.on("tabBeforeDelete("+this.config.tabFilter+")",function(e){var t=h(`.layui-tab-title li[lay-id="${e.id}"]`),i=t.text();if("false"===t.attr("lay-allowclose"))return d.msg(i+" 标签禁止删除"),!1;o.delTabData(e.id)})},rightMenu:function(e){return new t(e)},autoScrollToActiveTab:function(e,t){var i,e=e.find(".layui-tab-title");t.length&&(i=e.width()-160,t[0].offsetLeft,e[0].scrollLeft,t=t[0].offsetLeft-i/2+t.outerWidth()/2,i=e[0].scrollWidth-i-160,t=Math.max(0,Math.min(t,i)),e.stop().animate({scrollLeft:t},200))},moveTabs:function(e){var t=h(this.config.tabsContent).find(".layui-tab-title"),i=t.find(".layui-this"),n=t.children("li"),i=n.index(i);let a;"prev"===e&&0<i?a=i-1:"next"===e&&i<n.length-1&&(a=i+1),void 0!==a&&((e=n.eq(a)).trigger("click"),f(t,e))},activeTabMenu:function(e){var t=h("#menu-container"),i=t.find("[lay-id]").filter(function(){return h(this).attr("lay-id")===e});t.find(".layui-nav-item").removeClass("layui-this"),0<i.length&&(t.find(".side-menu-container").hide(),t=i.parents(".side-menu-container").show().attr("data-tab-id"),i.parent(".layui-nav-item").addClass("layui-this"),(i=i.parents(".side-menu-container > .layui-nav-item")).hasClass("layui-nav-itemed")||i.addClass("layui-nav-itemed"),t)&&((i=h("#topNav")).find(".layui-nav-item").removeClass("layui-this"),i.find('.layui-nav-item[data-tab-id="'+t+'"]').addClass("layui-this"))},requestFullscreen:function(i){return new Promise((e,t)=>{i.requestFullscreen?i.requestFullscreen().then(e).catch(t):i.mozRequestFullScreen?i.mozRequestFullScreen().then(e).catch(t):i.webkitRequestFullscreen?i.webkitRequestFullscreen().then(e).catch(t):i.msRequestFullscreen?i.msRequestFullscreen().then(e).catch(t):t(new Error("浏览器不支持全屏"))})},exitFullscreen:function(){return new Promise((e,t)=>{document.exitFullscreen?document.exitFullscreen().then(e).catch(t):document.mozCancelFullScreen?document.mozCancelFullScreen().then(e).catch(t):document.webkitExitFullscreen?document.webkitExitFullscreen().then(e).catch(t):document.msExitFullscreen?document.msExitFullscreen().then(e).catch(t):t(new Error("浏览器不支持退出全屏"))})}};e("pageTab",m)});