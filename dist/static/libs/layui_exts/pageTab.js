layui.define(["element","util","layer"],function(e){let l=layui.element,r=layui.jquery,c=layui.layer;function t(e){var t={filter:u.config.tabFilter,navArr:[{eventName:"closeThis",title:"关闭",icon:"iconfont icon-cuowuguanbiquxiao"},{eventName:"refreshThis",title:"刷新标签",icon:"iconfont icon-shuaxin"},{eventName:"toggleFullScreen",title:"全屏显示",icon:"layui-icon layui-icon-screen-full"},{eventName:"line",title:""},{eventName:"closeLeft",title:"关闭左侧标签页",icon:"iconfont icon-diyiye"},{eventName:"closeRight",title:"关闭右侧标签页",icon:"iconfont icon-zuihouye"},{eventName:"line",title:""},{eventName:"closeOther",title:"关闭其它标签页",icon:"iconfont icon-hengxiangshouqi"},{eventName:"closeAll",title:"关闭所有标签页",icon:"iconfont icon-guanbiquanbu"}]};this.config={...t,...e},this.config&&this.render(this.config)}function o(e,t){e.scrollLeft();var i=t.offset().left-e.offset().left+e.scrollLeft(),t=t.outerWidth();e.animate({scrollLeft:i-(e.width()-t)/2},300)}t.prototype.render=function(e){e.filter?(this.filter=e.filter,this.navArr=e.navArr,document.fullscreenElement===this.fullScreenTarget?this.menuElement||(this.menuElement=r("<ul class='right-menu'></ul>").appendTo(this.fullScreenTarget)):this.menuElement||(this.menuElement=r("<ul class='right-menu'></ul>").appendTo("body")),this.renderMenuItems(),this.bindEvents(),this.fullScreenTarget=document.querySelector('[lay-filter="'+this.filter+'"]'),this.fullScreenTarget?this.fullScreenTarget.addEventListener("fullscreenchange",()=>{this.updateFullScreenMenuItem(),this.updateMenuParent()}):console.error("[ERROR] 未找到符合 'filter' 的全屏目标元素！")):console.error("[ERROR] 使用 tabRightMenu 组件需要指定 'filter' 属性！")},t.prototype.updateMenuParent=function(){document.fullscreenElement===this.fullScreenTarget?this.menuElement.appendTo(this.fullScreenTarget):this.menuElement.appendTo("body")},t.prototype.renderMenuItems=function(){this.menuElement.empty(),this.navArr.forEach(e=>{("line"===e.eventName?r("<hr>"):r("<li class='right-menu-item'  data-event='"+e.eventName+"'><i class='"+e.icon+"'></i> "+e.title+"</li>")).appendTo(this.menuElement)}),this.updateFullScreenMenuItem()},t.prototype.updateFullScreenMenuItem=function(){var e=this.menuElement.find("[data-event='toggleFullScreen']"),t=r('[lay-header-event="tabFullScreen"]');document.fullscreenElement===this.fullScreenTarget?(e.html("<i class='layui-icon layui-icon-screen-restore'></i> 退出全屏"),t.html("<em class='layui-icon layui-icon-screen-restore'></em>")):(e.html("<i class='layui-icon layui-icon-screen-full'></i> 全屏显示"),t.html("<em class='layui-icon layui-icon-screen-full'></em>"))},t.prototype.bindEvents=function(){var t=this;r("#happy-content .layui-body-tabs").on("contextmenu",".layui-tab-title > li",e=>{e.preventDefault(),t.showMenu(e,r(e.currentTarget).attr("lay-id"))}),r(document).off("click.rightMenu"),r(document).on("click.rightMenu",e=>{t.menuElement.is(e.target)||0!==t.menuElement.has(e.target).length||t.hideMenu()}),t.menuElement.off("click.rightMenuItem"),t.menuElement.on("click.rightMenuItem","li[data-event]",e=>{e.stopPropagation();e=r(e.currentTarget).attr("data-event");e&&t.handleMenuItemClick(e)})},t.prototype.showMenu=function(e,t){var i,n;t&&(this.currentActiveTabID=t,t=this.menuElement,i=r(document).width()-e.clientX<t.width()?e.clientX-t.width():e.clientX,e=r(document).height()-e.clientY<t.height()?e.clientY-t.height():e.clientY,document.fullscreenElement===this.fullScreenTarget&&(i-=(n=r(this.fullScreenTarget).offset()).left,e-=n.top),t.css({left:i,top:e}).show())},t.prototype.hideMenu=function(){this.menuElement.hide()},t.prototype.handleMenuItemClick=function(t){if(t){let e=r(".layui-tab[lay-filter='"+this.filter+"'] li"),n=!1;switch(t){case"refreshThis":r(`.layui-tab-item[lay-id="${this.currentActiveTabID}"]`).length&&r('[lay-header-event="refreshTab"]').trigger("click");break;case"closeThis":l.tabDelete(this.filter,this.currentActiveTabID);var i=e.not(`[lay-id="${this.currentActiveTabID}"]`).first();i.length&&l.tabChange(this.filter,i.attr("lay-id"));break;case"toggleFullScreen":this.toggleFullScreen();break;case"closeAll":r.each(e,(e,t)=>{t=r(t).attr("lay-id");l.tabDelete(this.filter,t)});break;case"closeOther":r.each(e,(e,t)=>{t=r(t).attr("lay-id");l.tabDelete(this.filter,t)});break;case"closeLeft":r.each(e,(e,t)=>{t=r(t).attr("lay-id");t===this.currentActiveTabID?n=!0:n||l.tabDelete(this.filter,t)});break;case"closeRight":n=!1,r.each(e,(e,t)=>{var i=r(t).attr("lay-id");i===this.currentActiveTabID?n=!0:n&&setTimeout(()=>{l.tabDelete(this.filter,i)},0)})}this.hideMenu()}},t.prototype.toggleFullScreen=function(){if(this.fullScreenTarget)if(document.fullscreenElement)try{u.exitFullscreen().then(()=>{this.updateFullScreenMenuItem(),this.updateMenuParent()}).catch(e=>{c.msg("无法退出全屏模式,请手动操作")})}catch(e){c.msg("无法退出全屏模式,请手动操作")}else try{u.requestFullscreen(this.fullScreenTarget).then(()=>{this.updateFullScreenMenuItem(),this.updateMenuParent()}).catch(e=>{c.msg("无法进入全屏模式,请手动操作")})}catch(e){c.msg("无法进入全屏模式,请手动操作")}else console.error("[ERROR] 未找到符合 'filter' 的全屏目标元素！")};let u={config:{tabFilter:"layout-filter-tab",tabsContent:"#happy-content > .layui-body-tabs"},showLoadingBar:function(){r("#loading-bar").css("width","0%").show(),setTimeout(()=>{r("#loading-bar").css("width","100%")},0)},hideLoadingBar:function(){setTimeout(()=>{r("#loading-bar").css("width","0%").hide()},2e3)},getActiveTabId:function(){return r(this.config.tabsContent).find(".layui-tab-title li[lay-id].layui-this").attr("lay-id")},refreshTab:function(){let n=this,e=this.getActiveTabId();if(e){var l=r(this.config.tabsContent).find(`.layui-tab-title li[lay-id="${e}"]`).attr("lay-url");if(l){let t=r(this.config.tabsContent).find(`.layui-tab-item[lay-id="${e}"] .happy-tab-content`),i=c.load();t.empty(),this.showLoadingBar(),r.ajax({url:l,type:"GET",success:function(e){t.html(e),c.close(i),setTimeout(()=>{t.show().addClass("animated slideInFromBottom")},100),n.hideLoadingBar()},error:function(){c.msg("刷新失败，请重试！"),n.hideLoadingBar()}})}else c.msg("该标签页没有关联的URL，无法刷新！")}},addTab:function(e){var t=String(e.id),i=e.url,e=e.title;this.tabIsExist(t)?l.tabChange(this.config.tabFilter,t):l.tabAdd(this.config.tabFilter,{id:t,title:e,url:i,change:!0,allowClose:!0})},updateTabData:function(t,e){var i=JSON.parse(sessionStorage.getItem("tabsList"))||[];-1===i.findIndex(e=>e.id===t)&&i.push({id:t,...e}),sessionStorage.setItem("tabsList",JSON.stringify(i)),sessionStorage.setItem("tabsActiveId",t)},delTabData:function(t){var e=JSON.parse(sessionStorage.getItem("tabsList"))||[];let i=sessionStorage.getItem("tabsActiveId");var n=e.findIndex(e=>e.id===t);-1!==n?(e.splice(n,1),t===i&&(0<e.length?(i=e[0].id,l.tabChange(this.config.tabFilter,i)):i=null),sessionStorage.setItem("tabsList",JSON.stringify(e)),sessionStorage.setItem("tabsActiveId",i)):t===i&&(i=0<e.length?e[0].id:null,sessionStorage.setItem("tabsActiveId",i))},tabIsExist:function(e){let t=!1;return r(this.config.tabsContent).find(".layui-tab-title li").each(function(){if(r(this).attr("lay-id")===e)return!(t=!0)}),t},clearOtherTabsContent:function(e){r(this.config.tabsContent).find(".layui-tab-item").each(function(){r(this).attr("lay-id")!==e&&r(this).empty()})},getProhibitTabListID:function(){return JSON.parse(localStorage.getItem("prohibitListID"))||[]},onTab:function(){let s=this;l.on("tab("+this.config.tabFilter+")",function(e){var t=r(e.elem),i=t.find(".layui-this");o(t,i);let n=e.id;t=r(`.layui-tab-title li[lay-id="${n}"]`);let l=t.attr("lay-url");i=t.attr("lay-allowclose");s.updateTabData(n,{id:n,title:t.text(),url:l,allowClose:i});let a=r(`.layui-tab-item[lay-id="${n}"]`);0!==a.find(".happy-tab-content").length&&a.find(".happy-tab-content").is(":visible")?setTimeout(()=>{a.find(".happy-tab-content").show().addClass("animated slideInFromBottom")},100):l&&(u.showLoadingBar(),r.ajax({url:l,type:"GET",dataType:"html",async:!1,success:function(e){a.html(`
                            <div class="happy-tab-content" 
                                 style="display:none;" 
                                 data-page-id="${n}" 
                                 data-src="${l}">
                                ${e}
                            </div>
                        `),setTimeout(()=>{a.find(".happy-tab-content").show().addClass("animated slideInFromBottom")},100),u.hideLoadingBar()},error:function(){c.msg("加载失败，请重试！"),u.hideLoadingBar()}})),u.clearOtherTabsContent(n)}),l.on("tabBeforeDelete("+this.config.tabFilter+")",function(e){var t=r(`.layui-tab-title li[lay-id="${e.id}"]`).text();if(s.getProhibitTabListID().includes(e.id))return c.msg(t+" 标签禁止删除"),!1;s.delTabData(e.id)})},rightMenu:function(e){return new t(e)},moveTabs:function(e){var t,i=r(this.config.tabsContent).find(".layui-tab-title"),n=i.find(".layui-this"),l=i.children("li"),n=l.index(n);"prev"===e&&0<n?t=n-1:"next"===e&&n<l.length-1&&(t=n+1),void 0!==t&&((e=l.eq(t)).trigger("click"),o(i,e))},requestFullscreen:function(i){return new Promise((e,t)=>{i.requestFullscreen?i.requestFullscreen().then(e).catch(t):i.mozRequestFullScreen?i.mozRequestFullScreen().then(e).catch(t):i.webkitRequestFullscreen?i.webkitRequestFullscreen().then(e).catch(t):i.msRequestFullscreen?i.msRequestFullscreen().then(e).catch(t):t(new Error("浏览器不支持全屏"))})},exitFullscreen:function(){return new Promise((e,t)=>{document.exitFullscreen?document.exitFullscreen().then(e).catch(t):document.mozCancelFullScreen?document.mozCancelFullScreen().then(e).catch(t):document.webkitExitFullscreen?document.webkitExitFullscreen().then(e).catch(t):document.msExitFullscreen?document.msExitFullscreen().then(e).catch(t):t(new Error("浏览器不支持退出全屏"))})}};e("pageTab",u)});