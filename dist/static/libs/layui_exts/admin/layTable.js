layui.define(["jquery","table","layer","treeTable","form","fieldHandler"],function(e){let d=layui.jquery,o=layui.table,s=layui.treeTable,c=layui.layer,u=layui.fieldHandler,f=layui.form;function y(e,t){let a=new URLSearchParams;var n,i,r;for(i in e.includes("?")&&([n,l]=e.split("?",2),a=new URLSearchParams(l),e=n),t)t.hasOwnProperty(i)&&(r=t[i],a.has(i)?a.set(i,r):a.append(i,r));var l=a.toString();return l&&(e+=(e.includes("?")?"&":"?")+l),e}e("layTable",{eventListeners:{},render:function(e){let i=this;let l=d.extend(!0,{},{elem:"#happyTable",where:{},on:{},isTree:!1,even:!0,skin:"row",autoSort:!1,tree:{},limit:"20",limits:[10,20,30,40,50,60,70,80,90,100,150,200],parseData:function(e){return{code:e.code,msg:e.msg,count:e.data.total,data:e.data.data}},loading:!0,initSort:{field:"id",type:"desc"},rightEdit:!0},e),a=(l.toolbar||(l.toolbar=l.elem+"ToolbarTop"),l.layFilters||(l.layFilters=l.elem.replace(/^#/,"")),l.url||(l.url=d(l.elem).data("url")),l.page||(l.limit="300"),u.init(l),{add:function(e,t,a){i.defaultSaveHandler(this,l.dataUrls.add,function(){i.reload(e.config.id)})},del:function(e,t,a){var n=o.checkStatus(e.config.id).data.map(function(e){return e.id});i.defaultDeleteHandler(l.dataUrls.del,n,function(){i.reload(e.config.id)})}}),n={del:function(e,t,a){var n=e.data.id;i.defaultDeleteHandler(l.dataUrls.del,n,function(){i.reload(e.config.id)})},edit:function(e,t,a){var n=y(l.dataUrls.edit,{id:e.data.id});i.defaultSaveHandler(this,n,function(){i.reload(e.config.id)})}};if(e.toolEvent&&d.extend(!0,n,e.toolEvent),e.toolbarEvent&&d.extend(!0,a,e.toolbarEvent),l.on.toolbar||(l.on.toolbar=function(e){if(e.config.layFilters!==l.layFilters)return!1;var t=a[e.event];"function"==typeof t&&t.call(this,e,function(){i.reload(e.config.id)},l.defaultDeleteHandler)}),l.on.tool||(l.on.tool=function(e){if(e.config.layFilters!==l.layFilters)return!1;var t=n[e.event];"function"==typeof t&&t.call(this,e,function(){i.reload(e.config.id)},l.defaultDeleteHandler)}),l.on.sort||(l.on.sort=function(e){if(e.config.layFilters!==l.layFilters)return!1;var t=e.field,a=e.type;i.reload(e.config.id,{initSort:e,where:{_order:t,_by:a}})}),l.on.edit||(l.on.edit=function(a){if(a.config.layFilters!==l.layFilters)return!1;let n=c.load(),i=a.field,r=a.value;var e=a.data,e=(a.getCol(),y(l.dataUrls.quick,{id:e.id}));if(""===r.replace(/\s/g,""))return c.tips("值不能为空",this,{tips:1}),a.reedit();d.ajax({url:e,type:"POST",dataType:"json",data:{field:i,value:r},success:function(e){var t;c.close(n),0===e.code?(c.msg(e.msg,this,{tips:1}),(t={})[i]=r,a.update(t,!0)):1<=e.code&&c.msg(e.msg)},error:function(e,t,a){c.close(n),c.msg("网络请求失败")}})}),l.isTree)for(var t in s.render(l),l.on)l.on.hasOwnProperty(t)&&s.on(t+"("+l.layFilters+")",l.on[t]);else for(var r in o.render(l),l.on)l.on.hasOwnProperty(r)&&o.on(r+"("+l.layFilters+")",l.on[r]);return f.on("switch(form-switch-edit)",function(e){var t=e.elem.name,a=i.getRowData(l.layFilters,e.elem),e=e.elem.checked?1:0,a=y(l.dataUrls.quick,{id:a.id});d.ajax({url:a,type:"POST",data:{field:t,value:e},success:function(e){0===e.code?c.msg("更新成功"):(c.msg("更新失败："+e.msg),layui.form.render("checkbox"))},error:function(){c.msg("请求失败，请稍后再试"),layui.form.render("checkbox")}})}),i},reload:function(a,e){if(null==a){let e=d("#happy-content"),t;if(0===(t=(t=e.find(".layui-tabs-body")).find(".layui-tabs-item .layui-show")).length)return;a=t.attr("id")}let t;(t=s&&d("#"+a).hasClass("layui-tree-table")?s:o).reload(a,e)},defaultDeleteHandler:function(t,a,n){c.confirm("确认删除？",function(e){d.ajax({url:t,type:"POST",data:{ids:a},success:function(e){0===e.code?(c.msg("删除成功"),n()):c.msg("删除失败: "+e.msg)},error:function(){c.msg("请求出错")}}),c.close(e)})},defaultSaveHandler:function(e,t,a){let n=d(e).text(),i=d(window).width(),r=d(window).height(),l=r-200,o=1400<=i?"800px":"80%";o="800px",d.ajax({url:t,method:"GET",success:function(e){if(e.code)return c.msg(e.msg);c.open({type:1,title:n,content:e,area:o,maxHeight:l})},error:function(e,t,a){console.error("Error:",t,a),c.msg("请求失败: "+t+", "+a,{icon:5})}})},getRowData:function(e,t){t=d(t).closest("tr").data("index");return o.cache[e][t]||{}}})});