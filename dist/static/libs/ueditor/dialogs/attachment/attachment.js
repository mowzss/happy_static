/*! UEditorPlus v2.0.0*/
!function(){function initTabs(){for(var e=$G("tabhead").children,t=0;t<e.length;t++)domUtils.on(e[t],"click",function(e){setTabFocus((e.target||e.srcElement).getAttribute("data-content-id"))});setTabFocus("upload")}function setTabFocus(e){if(e){for(var t,i=$G("tabhead").children,s=0;s<i.length;s++)(t=i[s].getAttribute("data-content-id"))==e?(domUtils.addClass(i[s],"focus"),domUtils.addClass($G(t),"focus")):(domUtils.removeClasses(i[s],"focus"),domUtils.removeClasses($G(t),"focus"));switch(e){case"upload":uploadFile=uploadFile||new UploadFile("queueList");break;case"online":onlineFile=onlineFile||new OnlineFile("fileList")}}}function initButtons(){dialog.onok=function(){for(var e,t=[],i=$G("tabhead").children,s=0;s<i.length;s++)if(domUtils.hasClass(i[s],"focus")){e=i[s].getAttribute("data-content-id");break}switch(e){case"upload":var t=uploadFile.getInsertList(),a=uploadFile.getQueueCount();if(a)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,a)+"</span>"),!1;break;case"online":t=onlineFile.getInsertList()}editor.execCommand("insertfile",t)}}function UploadFile(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}function OnlineFile(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}var uploadFile,onlineFile;window.onload=function(){initTabs(),initButtons()},UploadFile.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){function t(i){function s(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}l.text(text).show()}var a=u('<li id="'+i.id+'"><p class="title">'+i.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),n=u('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(a),r=a.find("p.progress span"),o=a.find("p.imgWrap"),l=u('<p class="error"></p>').hide().appendTo(a);"invalid"===i.getStatus()?s(i.statusText):(o.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+i.ext.toLowerCase()+"|")?o.empty().addClass("notimage").append('<i class="file-preview file-type-'+i.ext.toLowerCase()+'"></i><span class="file-title" title="'+i.name+'">'+i.name+"</span>"):browser.ie&&browser.version<=7?o.text(lang.uploadNoPreview):d.makeThumb(i,function(e,t){e||!t?o.text(lang.uploadNoPreview):(e=u('<img src="'+t+'">'),o.empty().append(e),e.on("error",function(){o.text(lang.uploadNoPreview)}))},v,x),b[i.id]=[i.size,0],i.rotation=0,i.ext&&-1!=S.indexOf(i.ext.toLowerCase())||(s("not_allow_type"),d.removeFile(i))),i.on("statuschange",function(e,t){"progress"===t?r.hide().width(0):"queued"===t&&(a.off("mouseenter mouseleave"),n.remove()),"error"===e||"invalid"===e?(s(i.statusText),b[i.id][1]=1):"interrupt"===e?s("interrupt"):"queued"===e?b[i.id][1]=0:"progress"===e&&(l.hide(),r.css("display","block")),a.removeClass("state-"+t).addClass("state-"+e)}),a.on("mouseenter",function(){n.stop().animate({height:30})}),a.on("mouseleave",function(){n.stop().animate({height:0})}),n.on("click","span",function(){var e;switch(u(this).index()){case 0:return void d.removeFile(i);case 1:i.rotation+=90;break;case 2:i.rotation-=90}w?(e="rotate("+i.rotation+"deg)",o.css({"-webkit-transform":e,"-mos-transform":e,"-o-transform":e,transform:e})):o.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(i.rotation/90%4+4)%4+")")}),a.insertBefore(c)}function i(){var e,i=0,s=0,t=h.children();u.each(b,function(e,t){s+=t[0],i+=t[0]*t[1]}),e=s?i/s:0,t.eq(0).text(Math.round(100*e)+"%"),t.eq(1).css("width",Math.round(100*e)+"%"),a()}function s(e){if(e!=C){var t=d.getStats();switch(p.removeClass("state-"+C),p.addClass("state-"+e),e){case"pedding":r.addClass("element-invisible"),o.addClass("element-invisible"),f.removeClass("element-invisible"),h.hide(),l.hide(),d.refresh();break;case"ready":f.addClass("element-invisible"),r.removeClass("element-invisible"),o.removeClass("element-invisible"),h.hide(),l.show(),p.text(lang.uploadStart),d.refresh();break;case"uploading":h.show(),l.hide(),p.text(lang.uploadPause);break;case"paused":h.show(),l.hide(),p.text(lang.uploadContinue);break;case"confirm":if(h.show(),l.hide(),p.text(lang.uploadStart),(t=d.getStats()).successNum&&!t.uploadFailNum)return void s("finish");break;case"finish":h.hide(),l.show(),t.uploadFailNum?p.text(lang.uploadRetry):p.text(lang.uploadStart)}C=e,a()}n.getQueueCount()?p.removeClass("disabled"):p.addClass("disabled")}function a(){var e,t="";"ready"===C?t=lang.updateStatusReady.replace("_",g).replace("_KB",WebUploader.formatSize(m)):"confirm"===C?(e=d.getStats()).uploadFailNum&&(t=lang.updateStatusConfirm.replace("_",e.successNum).replace("_",e.successNum)):(e=d.getStats(),t=lang.updateStatusFinish.replace("_",g).replace("_KB",WebUploader.formatSize(m)).replace("_",e.successNum),e.uploadFailNum&&(t+=lang.updateStatusError.replace("_",e.uploadFailNum))),l.html(t)}var d,n=this,u=jQuery,e=n.$wrap,r=e.find(".filelist"),o=e.find(".statusBar"),l=o.find(".info"),p=e.find(".uploadBtn"),c=(e.find(".filePickerBtn"),e.find(".filePickerBlock")),f=e.find(".placeholder"),h=o.find(".progress").hide(),g=0,m=0,e=window.devicePixelRatio||1,v=113*e,x=113*e,C="",b={},w=e="transition"in(e=document.createElement("p").style)||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e,U=editor.getActionUrl(editor.getOpt("fileActionName")),F=editor.getOpt("fileMaxSize"),S=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");WebUploader.Uploader.support()?editor.getOpt("fileActionName")?(e={pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:U,fileVal:editor.getOpt("fileFieldName"),duplicate:!0,fileSingleSizeLimit:F,headers:editor.getOpt("serverHeaders")||{},compress:!1},editor.getOpt("uploadServiceEnable")&&(e.customUpload=function(t,i){editor.getOpt("uploadServiceUpload")("attachment",t,{success:function(e){i.onSuccess(t,{_raw:JSON.stringify(e)})},error:function(e){i.onError(t,e)},progress:function(e){i.onProgress(t,e)}},{from:"attachment"})}),(d=n.uploader=WebUploader.create(e)).addButton({id:"#filePickerBlock"}),d.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),s("pedding"),d.on("fileQueued",function(e){e.ext&&-1!=S.indexOf(e.ext.toLowerCase())&&e.size<=F&&(g++,m+=e.size),1===g&&(f.addClass("element-invisible"),o.show()),t(e)}),d.on("fileDequeued",function(e){var t;e.ext&&-1!=S.indexOf(e.ext.toLowerCase())&&e.size<=F&&(g--,m-=e.size),t=u("#"+(e=e).id),delete b[e.id],i(),t.off().find(".file-panel").off().end().remove(),i()}),d.on("filesQueued",function(e){d.isInProgress()||"pedding"!=C&&"finish"!=C&&"confirm"!=C&&"ready"!=C||s("ready"),i()}),d.on("all",function(e,t){switch(e){case"uploadFinished":s("confirm");break;case"startUpload":var i=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",i=utils.formatUrl(U+(-1==U.indexOf("?")?"?":"&")+"encode=utf-8&"+i);d.option("server",i),s("uploading");break;case"stopUpload":s("paused")}}),d.on("uploadBeforeSend",function(e,t,i){-1!=U.toLowerCase().indexOf("jsp")&&(i.X_Requested_With="XMLHttpRequest")}),d.on("uploadProgress",function(e,t){u("#"+e.id).find(".progress span").css("width",100*t+"%"),b[e.id][1]=t,i()}),d.on("uploadSuccess",function(t,e){t=u("#"+t.id);try{var i=e._raw||e,s=utils.str2json(i);"SUCCESS"==(s=editor.getOpt("serverResponsePrepare")(s)).state?(n.fileList.push(s),t.append('<span class="success"></span>'),editor.fireEvent("uploadsuccess",{res:s,type:"file"})):t.find(".error").text(s.state).show()}catch(e){t.find(".error").text(lang.errorServerUpload).show()}}),d.on("uploadError",function(e,t){}),d.on("error",function(e,t,i){"F_EXCEED_SIZE"===e?editor.getOpt("tipError")(lang.errorExceedSize+" "+(t/1024/1024).toFixed(1)+"MB"):console.log("error",e,t,i)}),d.on("uploadComplete",function(e,t){}),p.on("click",function(){return!u(this).hasClass("disabled")&&void("ready"===C||"paused"===C?d.upload():"uploading"===C&&d.stop())}),p.addClass("state-"+C),i()):u("#filePickerReady").after(u("<div>").html(lang.errorLoadConfig)).hide():u("#filePickerReady").after(u("<div>").html(lang.errorNotSupport)).hide()},getQueueCount:function(){for(var e,t=0,i=this.uploader.getFiles(),s=0;e=i[s++];)"queued"!=(e=e.getStatus())&&"uploading"!=e&&"progress"!=e||t++;return t},getInsertList:function(){for(var e,t,i=[],s=editor.getOpt("fileUrlPrefix"),a=0;a<this.fileList.length;a++)e=(t=this.fileList[a]).url,i.push({title:t.original||e.substr(e.lastIndexOf("/")+1),url:s+e});return i}},OnlineFile.prototype={init:function(){this.initContainer(),this.initEvents(),this.initData()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var t=this;domUtils.on($G("fileList"),"scroll",function(e){this.scrollHeight-(this.offsetHeight+this.scrollTop)<10&&t.getFileData()}),domUtils.on(this.list,"click",function(e){e=(e.target||e.srcElement).parentNode;"li"==e.tagName.toLowerCase()&&(domUtils.hasClass(e,"selected")?domUtils.removeClasses(e,"selected"):domUtils.addClass(e,"selected"))})},initData:function(){this.state=0,this.listSize=editor.getOpt("fileManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getFileData()},getFileData:function(){var _this=this;_this.listEnd||this.isLoadingData||(this.isLoadingData=!0,ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1e5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),headers:editor.options.serverHeaders||{},method:"get",onsuccess:function(r){try{var json=eval("("+r.responseText+")");"SUCCESS"==json.state&&(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total&&(_this.listEnd=!0),_this.isLoadingData=!1)}catch(e){var list;-1!=r.responseText.indexOf("ue_separate_ue")&&(list=r.responseText.split(r.responseText),_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1)}},onerror:function(){_this.isLoadingData=!1}}))},pushData:function(e){for(var t,i,s,a,n,r,o=this,l=editor.getOpt("fileManagerUrlPrefix"),d=0;d<e.length;d++)e[d]&&e[d].url&&(a=document.createElement("li"),n=document.createElement("span"),r=e[d].url.substr(e[d].url.lastIndexOf(".")+1),-1!="png|jpg|jpeg|gif|bmp".indexOf(r)?(t=document.createElement("img"),domUtils.on(t,"load",(e=>function(){o.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)})(t)),t.width=113,t.setAttribute("src",l+e[d].url+(-1==e[d].url.indexOf("?")?"?noCache=":"&noCache=")+(+new Date).toString(36))):(i=document.createElement("i"),(s=document.createElement("span")).innerHTML=e[d].original||e[d].url.substr(e[d].url.lastIndexOf("/")+1),(t=document.createElement("div")).appendChild(i),t.appendChild(s),domUtils.addClass(t,"file-wrapper"),domUtils.addClass(s,"file-title"),domUtils.addClass(i,"file-type-"+r),domUtils.addClass(i,"file-preview")),domUtils.addClass(n,"icon"),a.setAttribute("data-url",l+e[d].url),e[d].original&&a.setAttribute("data-title",e[d].original),a.appendChild(t),a.appendChild(n),this.list.insertBefore(a,this.clearFloat))},scale:function(e,t,i,s){var a=e.width,n=e.height;"justify"==s?n<=a?(e.width=t,e.height=i*n/a,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t*a/n,e.height=i,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"):n<=a?(e.width=t*a/n,e.height=i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t,e.height=i*n/a,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px")},getInsertList:function(){for(var e,t,i=this.list.children,s=[],a=0;a<i.length;a++)domUtils.hasClass(i[a],"selected")&&(e=i[a].getAttribute("data-url"),t=i[a].getAttribute("data-title")||e.substr(e.lastIndexOf("/")+1),s.push({title:t,url:e}));return s}}}();